name: Build All Platforms and Sync to Gitee

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  # ===================================================
  # 第一阶段：矩阵编译 (同时构建 Win, Mac-ARM, Linux)
  # ===================================================
  build:
    strategy:
      matrix:
        include:
          # Windows (x64)
          - os: windows-latest
            platform_name: windows
            executable_name: JLC2KiCadLib.exe
            final_name: JLC2KiCadLib_windows.exe
          
          # Linux (x64) - 使用较旧版本以保证兼容性
          - os: ubuntu-20.04
            platform_name: linux
            executable_name: JLC2KiCadLib
            final_name: JLC2KiCadLib_linux

          # macOS (ARM64 / Apple Silicon)
          # GitHub Actions 的 macos-15 运行在 ARM64 架构上
          - os: macos-15
            platform_name: macos_arm64
            executable_name: JLC2KiCadLib
            final_name: JLC2KiCadLib_macos_arm64

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests colorama pyinstaller

    - name: Build with PyInstaller
      run: |
        # PyInstaller 会自动检测当前系统架构 (Win=x64, Mac=ARM64)
        pyinstaller --onefile JLC2KiCadLib/JLC2KiCadLib.py --name ${{ matrix.executable_name }}

    - name: Rename Output
      shell: bash
      run: |
        # 重命名文件以便区分平台
        mv dist/${{ matrix.executable_name }} dist/${{ matrix.final_name }}

    # 上传编译好的文件到 GitHub 临时区
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.platform_name }}
        path: dist/${{ matrix.final_name }}

  # ===================================================
  # 第二阶段：收集所有文件并推送到 Gitee
  # ===================================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout for License
      uses: actions/checkout@v3

    # 下载刚才三个系统编译出来的文件
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: build-*
        merge-multiple: true
        path: ./artifacts

    - name: Push to Gitee
      env:
        GITEE_USER: ${{ secrets.GITEE_USER }}
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        GITEE_REPO: ${{ secrets.GITEE_REPO }}
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # 克隆 Gitee 仓库
        git clone https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_USER}/${GITEE_REPO}.git gitee_repo
        cd gitee_repo
        
        # 切换到 binaries 分支
        git checkout --orphan binaries || git checkout binaries
        
        # 清空旧文件
        rm -rf *
        
        # 复制新文件 (Win, Linux, Mac-ARM)
        cp ../artifacts/* .
        cp ../LICENSE .
        
        # 提交推送
        git add .
        git commit -m "Update binaries (Win/Linux/Mac-ARM) $(date +'%Y-%m-%d')"
        git push origin binaries --force
