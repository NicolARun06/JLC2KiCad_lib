name: Auto Build & Sync (Robust Version)

# æˆäºˆå†™æƒé™
permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  # ===================================================
  # ä»»åŠ¡ä¸€ï¼šçœ‹é—¨äºº (æ™ºèƒ½åˆ¤æ–­ + å®Œæ•´æ€§æ£€æŸ¥)
  # ===================================================
  check_condition:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.analyze.outputs.should_run }}
      version_num: ${{ steps.analyze.outputs.version_num }}
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 

      - name: Analyze Condition
        id: analyze
        shell: bash
        run: |
          # åˆå§‹åŒ–é»˜è®¤çŠ¶æ€
          SHOULD_BUILD="false"
          ver_num="none"

          # --- 1. æ£€æŸ¥ GitHub è¿œç¨‹åˆ†æ”¯åŠæ–‡ä»¶å®Œæ•´æ€§ ---
          echo "ğŸ” Checking remote branch status..."
          
          # å°è¯•è·å– binaries åˆ†æ”¯çš„ä¿¡æ¯
          if git fetch origin binaries; then
            echo "âœ… Branch 'binaries' exists."
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ (JLC2KiCadLib_windows.exe å’Œ version.txt)
            # git ls-tree å¯ä»¥ä¸åˆ‡æ¢åˆ†æ”¯ç›´æ¥æŸ¥çœ‹å†…å®¹
            if git ls-tree -r origin/binaries | grep -q "JLC2KiCadLib_windows.exe" && \
               git ls-tree -r origin/binaries | grep -q "version.txt"; then
               echo "âœ… Artifacts seem intact."
               ARTIFACTS_OK="true"
            else
               echo "âš ï¸ Branch exists but ARTIFACTS MISSING. Force rebuild."
               ARTIFACTS_OK="false"
            fi
          else
            echo "âš ï¸ Branch 'binaries' does NOT exist. First run detected."
            ARTIFACTS_OK="false"
          fi

          # --- 2. æ£€æŸ¥ Commit Message ç‰ˆæœ¬å· ---
          MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $MSG"
          REGEX="version\s+[0-9.]+\s+->\s+([0-9.]+)"
          
          # --- 3. ç»¼åˆå†³ç­–é€»è¾‘ ---
          
          if [[ "$ARTIFACTS_OK" == "false" ]]; then
            # æƒ…å†µA: åˆ†æ”¯ä¸å­˜åœ¨ æˆ– æ–‡ä»¶ç¼ºå¤± -> å¼ºåˆ¶æ„å»º
            echo "ğŸš€ Integrity check failed. Initiating repair build."
            SHOULD_BUILD="true"
            ver_num="repair-build"

          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # æƒ…å†µB: æ‰‹åŠ¨è§¦å‘ -> å¼ºåˆ¶æ„å»º
            echo "ğŸ‘† Manual Trigger detected. Forcing build."
            SHOULD_BUILD="true"
            ver_num="manual-build"

          elif [[ "$MSG" =~ $REGEX ]]; then
            # æƒ…å†µC: å‘ç°åŸä½œè€…å‘ç‰ˆ -> æ„å»º
            NEW_VER="${BASH_REMATCH[1]}"
            echo "ğŸ‰ New Version detected: $NEW_VER"
            SHOULD_BUILD="true"
            ver_num="$NEW_VER"
            
          else
            # æƒ…å†µD: å®Œå¥½æ— æŸä¸”æ— æ›´æ–° -> è·³è¿‡
            echo "zzz Environment healthy & no update. Sleeping."
            SHOULD_BUILD="false"
          fi
          
          # è¾“å‡ºç»“æœ
          echo "should_run=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          echo "version_num=$ver_num" >> $GITHUB_OUTPUT

  # ===================================================
  # ä»»åŠ¡äºŒï¼šçŸ©é˜µç¼–è¯‘
  # ===================================================
  build:
    needs: check_condition
    if: needs.check_condition.outputs.should_run == 'true'
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform_name: windows
            executable_name: JLC2KiCadLib.exe
            final_name: JLC2KiCadLib_windows.exe
          
          - os: ubuntu-22.04
            platform_name: linux
            executable_name: JLC2KiCadLib
            final_name: JLC2KiCadLib_linux

          - os: macos-15
            platform_name: macos_arm64
            executable_name: JLC2KiCadLib
            final_name: JLC2KiCadLib_macos_arm64

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests colorama pyinstaller

    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile JLC2KiCadLib/JLC2KiCadLib.py --name ${{ matrix.executable_name }}

    - name: Rename Output
      shell: bash
      run: |
        mv dist/${{ matrix.executable_name }} dist/${{ matrix.final_name }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.platform_name }}
        path: dist/${{ matrix.final_name }}

  # ===================================================
  # ä»»åŠ¡ä¸‰ï¼šåŒé‡éƒ¨ç½² (ä¿®å¤äº† git commit æŠ¥é”™)
  # ===================================================
  deploy:
    needs: [check_condition, build]
    if: needs.check_condition.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Source for Zip
      uses: actions/checkout@v3
      
    - name: Prepare Files
      # ä½¿ç”¨ç¯å¢ƒå˜é‡æ¥æ¥æ”¶ç‰ˆæœ¬å·ï¼Œé˜²æ­¢æ³¨å…¥é”™è¯¯
      env:
        VERSION_TAG: ${{ needs.check_condition.outputs.version_num }}
      run: |
        zip -r master.zip . -x "*.git*" ".github*"
        # ç¡®ä¿ç‰ˆæœ¬å·ä¸ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™ç»™é»˜è®¤å€¼
        echo "${VERSION_TAG:-unknown}" > version.txt

    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: build-*
        merge-multiple: true
        path: ./artifacts

    - name: Push to Remotes
      env:
        GITEE_USER: ${{ secrets.GITEE_USER }}
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        GITEE_REPO: ${{ secrets.GITEE_REPO }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # å†æ¬¡å¼•å…¥ç‰ˆæœ¬å·ï¼Œä¾› git commit ä½¿ç”¨
        VERSION_TAG: ${{ needs.check_condition.outputs.version_num }}
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        mkdir deploy_package
        cp artifacts/* deploy_package/
        cp master.zip deploy_package/
        cp version.txt deploy_package/
        cp LICENSE deploy_package/
        
        cd deploy_package
        git init
        git checkout -b binaries
        git add .
        
        # ã€ä¿®å¤æ ¸å¿ƒã€‘ä½¿ç”¨ Shell å˜é‡é»˜è®¤å€¼è¯­æ³• :-
        # å¦‚æœ VERSION_TAG ä¸ºç©ºï¼Œå°±ä½¿ç”¨ 'auto-recovery' ä½œä¸ºæ¶ˆæ¯
        COMMIT_MSG="Deploy Build ${VERSION_TAG:-auto-recovery}"
        echo "Committing with message: $COMMIT_MSG"
        
        git commit -m "$COMMIT_MSG"
        
        # æ¨é€ A: GitHub
        git remote add github_origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
        git push github_origin binaries --force
        
        # æ¨é€ B: Gitee
        git remote add gitee_origin "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_USER}/${GITEE_REPO}.git"
        git push gitee_origin binaries --force
