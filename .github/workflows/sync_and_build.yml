name: Auto Build & Sync (Fix Relative Import)

permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  # ===================================================
  # ä»»åŠ¡ä¸€ï¼šçœ‹é—¨äºº (ä¿æŒä¸å˜)
  # ===================================================
  check_condition:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.analyze.outputs.should_run }}
      version_num: ${{ steps.analyze.outputs.version_num }}
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          fetch-depth: 100

      - name: Analyze Condition
        id: analyze
        shell: bash
        run: |
          function get_last_version() {
            local ver=$(git log -n 100 --pretty=%B | grep -oP "version\s+[0-9.]+\s+->\s+\K[0-9.]+" | head -n 1)
            if [[ -z "$ver" ]]; then echo "0.0.0"; else echo "$ver"; fi
          }

          MSG=$(git log -1 --pretty=%B)
          REGEX="version\s+[0-9.]+\s+->\s+([0-9.]+)"
          
          if [[ "$MSG" =~ $REGEX ]]; then
             CURRENT_VER="${BASH_REMATCH[1]}"
          else
             CURRENT_VER=$(get_last_version)
          fi

          echo "ðŸ” Checking artifacts status..."
          if git fetch origin binaries; then
            if git ls-tree -r origin/binaries | grep -q "JLC2KiCadLib_windows.exe" && \
               git ls-tree -r origin/binaries | grep -q "version.txt"; then
               ARTIFACTS_OK="true"
            else
               ARTIFACTS_OK="false"
            fi
          else
            ARTIFACTS_OK="false"
          fi

          SHOULD_BUILD="false"
          FINAL_VER_TAG="$CURRENT_VER"

          if [[ "$ARTIFACTS_OK" == "false" ]]; then
            SHOULD_BUILD="true"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SHOULD_BUILD="true"
          elif [[ "$MSG" =~ $REGEX ]]; then
            SHOULD_BUILD="true"
          else
            SHOULD_BUILD="false"
          fi
          
          echo "should_run=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          echo "version_num=$FINAL_VER_TAG" >> $GITHUB_OUTPUT

  # ===================================================
  # ä»»åŠ¡äºŒï¼šçŸ©é˜µç¼–è¯‘ (æ ¸å¿ƒä¿®æ”¹ç‚¹)
  # ===================================================
  build:
    needs: check_condition
    if: needs.check_condition.outputs.should_run == 'true'
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform_name: windows
            executable_name: JLC2KiCadLib.exe
            final_name: JLC2KiCadLib_windows.exe
          
          - os: ubuntu-22.04
            platform_name: linux
            executable_name: JLC2KiCadLib
            final_name: JLC2KiCadLib_linux

          - os: macos-15
            platform_name: macos_arm64
            executable_name: JLC2KiCadLib
            final_name: JLC2KiCadLib_macos_arm64

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # ã€ä¿®æ”¹ç‚¹ 1ã€‘å®‰è£…ä¾èµ–
    # ä½¿ç”¨ pip install . å®‰è£…å½“å‰åŒ…ï¼Œè§£å†³åŒ…ç»“æž„è¯†åˆ«é—®é¢˜
    # åŒæ—¶æ˜¾å¼å®‰è£… pyinstaller, requests, colorama ä»¥é˜²ä¸‡ä¸€
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install . requests colorama pyinstaller

    # ã€ä¿®æ”¹ç‚¹ 2ã€‘åŠ¨æ€ç”Ÿæˆå…¥å£æ–‡ä»¶å¹¶ç¼–è¯‘
    # ä½¿ç”¨ bash çš„ heredoc è¯­æ³•ç”Ÿæˆä¸´æ—¶è„šæœ¬
    # å¼ºåˆ¶è®© PyInstaller é€šè¿‡ç»å¯¹å¯¼å…¥è°ƒç”¨åŒ…
    - name: Build with PyInstaller
      shell: bash
      run: |
        # 1. åŠ¨æ€ç”Ÿæˆå…¥å£è„šæœ¬
        cat > entry_for_pyinstaller.py << 'EOF'
        from JLC2KiCadLib.JLC2KiCadLib import main

        if __name__ == "__main__":
            main()
        EOF

        # 2. æ‰“å°ä¸€ä¸‹çœ‹æ˜¯å¦ç”ŸæˆæˆåŠŸ (è°ƒè¯•ç”¨)
        cat entry_for_pyinstaller.py

        # 3. å¯¹è¿™ä¸ªä¸´æ—¶è„šæœ¬è¿›è¡Œæ‰“åŒ…
        # æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦å†æŒ‡å®šè·¯å¾„äº†ï¼Œå› ä¸ºå°±åœ¨å½“å‰ç›®å½•ä¸‹
        pyinstaller --onefile entry_for_pyinstaller.py --name ${{ matrix.executable_name }}

    - name: Rename Output
      shell: bash
      run: |
        mv dist/${{ matrix.executable_name }} dist/${{ matrix.final_name }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.platform_name }}
        path: dist/${{ matrix.final_name }}

  # ===================================================
  # ä»»åŠ¡ä¸‰ï¼šåŒé‡éƒ¨ç½² (ä¿æŒä¸å˜)
  # ===================================================
  deploy:
    needs: [check_condition, build]
    if: needs.check_condition.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Source for Zip
      uses: actions/checkout@v3
      
    - name: Prepare Files
      env:
        VERSION_TAG: ${{ needs.check_condition.outputs.version_num }}
      run: |
        zip -r master.zip . -x "*.git*" ".github*"
        echo "${VERSION_TAG:-unknown}" > version.txt

    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: build-*
        merge-multiple: true
        path: ./artifacts

    - name: Push to Remotes
      env:
        GITEE_USER: ${{ secrets.GITEE_USER }}
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        GITEE_REPO: ${{ secrets.GITEE_REPO }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VERSION_TAG: ${{ needs.check_condition.outputs.version_num }}
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # å¢žå¤§ç¼“å†²åŒºï¼Œé˜²æ­¢RPC failed
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 1000
        git config --global http.lowSpeedTime 600
        
        mkdir deploy_package
        cp artifacts/* deploy_package/
        cp master.zip deploy_package/
        cp version.txt deploy_package/
        cp LICENSE deploy_package/
        
        cd deploy_package
        git init
        git checkout -b binaries
        git add .
        
        COMMIT_MSG="Deploy Version ${VERSION_TAG:-auto-recovery}"
        git commit -m "$COMMIT_MSG"
        
        # 1. GitHub Push
        git remote add github_origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
        echo "ðŸš€ Pushing to GitHub..."
        git push github_origin binaries --force
        
        # 2. Gitee Push
        git remote add gitee_origin "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_USER}/${GITEE_REPO}.git"
        echo "ðŸš€ Pushing to Gitee..."
        git push gitee_origin binaries --force
