name: Smart Build based on Commit Message

on:
  # æ¯å¤©æ£€æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '0 0 * * *'
  # æ‰‹åŠ¨è§¦å‘ (æ–¹ä¾¿è°ƒè¯•ï¼Œæ‰‹åŠ¨è§¦å‘é»˜è®¤ä¼šå¼ºåˆ¶æ‰§è¡Œæ„å»º)
  workflow_dispatch:
  # å½“ä»£ç æ›´æ–°æ—¶
  push:
    branches: [ main, master ]

jobs:
  # ===================================================
  # ä»»åŠ¡ä¸€ï¼šçœ‹é—¨äºº (æ£€æŸ¥æ˜¯å¦éœ€è¦å‘ç‰ˆ)
  # ===================================================
  check_version:
    runs-on: ubuntu-latest
    # å®šä¹‰è¾“å‡ºå˜é‡ï¼Œä¾›åç»­ä»»åŠ¡ä½¿ç”¨
    outputs:
      should_run: ${{ steps.analyze.outputs.should_run }}
      version_num: ${{ steps.analyze.outputs.version_num }}
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          fetch-depth: 2 #ä»¥æ­¤è·å–è¶³å¤Ÿçš„æäº¤å†å²

      - name: Analyze Commit Message
        id: analyze
        shell: bash
        run: |
          # è·å–æœ€è¿‘ä¸€æ¬¡æäº¤çš„ä¿¡æ¯
          MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $MSG"
          
          # å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼ï¼šåŒ¹é… "version 1.0.35 -> 1.0.36" è¿™ç§æ ¼å¼
          # æ•è·ç»„1 æ˜¯æ—§ç‰ˆæœ¬ï¼Œæ•è·ç»„2 æ˜¯æ–°ç‰ˆæœ¬
          REGEX="version\s+[0-9.]+\s+->\s+([0-9.]+)"
          
          # åˆ¤æ–­é€»è¾‘
          if [[ "$MSG" =~ $REGEX ]]; then
            NEW_VER="${BASH_REMATCH[1]}"
            echo "âœ… Detect Release Version: $NEW_VER"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "version_num=$NEW_VER" >> $GITHUB_OUTPUT
            
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # å¦‚æœæ˜¯æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘ï¼Œå¼ºåˆ¶è¿è¡Œï¼Œç‰ˆæœ¬å·è®¾ä¸º manual
            echo "âš ï¸ Manual Trigger detected. Forcing build."
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "version_num=manual-build" >> $GITHUB_OUTPUT
            
          else
            echo "ğŸ›‘ No version change detected. Skipping build."
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "version_num=none" >> $GITHUB_OUTPUT
          fi

  # ===================================================
  # ä»»åŠ¡äºŒï¼šçŸ©é˜µç¼–è¯‘ (ä¾èµ–ä»»åŠ¡ä¸€çš„ç»“æœ)
  # ===================================================
  build:
    needs: check_version
    # ã€å…³é”®ã€‘åªæœ‰å½“çœ‹é—¨äººè¯´ true æ—¶ï¼Œæˆ–è€…æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œæ‰è¿è¡Œ
    if: needs.check_version.outputs.should_run == 'true'
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform_name: windows
            executable_name: JLC2KiCadLib.exe
            final_name: JLC2KiCadLib_windows.exe
          
          - os: ubuntu-22.04
            platform_name: linux
            executable_name: JLC2KiCadLib
            final_name: JLC2KiCadLib_linux

          - os: macos-15 # ARM64
            platform_name: macos_arm64
            executable_name: JLC2KiCadLib
            final_name: JLC2KiCadLib_macos_arm64

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests colorama pyinstaller

    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile JLC2KiCadLib/JLC2KiCadLib.py --name ${{ matrix.executable_name }}

    - name: Rename Output
      shell: bash
      run: |
        mv dist/${{ matrix.executable_name }} dist/${{ matrix.final_name }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.platform_name }}
        path: dist/${{ matrix.final_name }}

  # ===================================================
  # ä»»åŠ¡ä¸‰ï¼šæ‰“åŒ…æºç å¹¶æ¨é€ Gitee
  # ===================================================
  deploy:
    needs: [check_version, build]
    if: needs.check_version.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Source for Zip
      uses: actions/checkout@v3
      
    # 1. ç”Ÿæˆ master.zip æºç åŒ…
    - name: Create Source Zip
      run: |
        # zip å‘½ä»¤æ‰“åŒ…å½“å‰ç›®å½•ï¼Œæ’é™¤ .git æ–‡ä»¶å¤¹
        zip -r master.zip . -x "*.git*" ".github*"

    # 2. ç”Ÿæˆ version.txt
    - name: Create Version File
      run: |
        # ä»ä»»åŠ¡ä¸€çš„è¾“å‡ºä¸­è·å–ç‰ˆæœ¬å·
        echo "${{ needs.check_version.outputs.version_num }}" > version.txt
        echo "Version file created: $(cat version.txt)"

    # 3. ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: build-*
        merge-multiple: true
        path: ./artifacts

    # 4. æ¨é€åˆ° Gitee
    - name: Push to Gitee
      env:
        GITEE_USER: ${{ secrets.GITEE_USER }}
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        GITEE_REPO: ${{ secrets.GITEE_REPO }}
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        git clone https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_USER}/${GITEE_REPO}.git gitee_repo
        cd gitee_repo
        
        git checkout --orphan binaries || git checkout binaries
        rm -rf *
        
        # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°ä»“åº“æ ¹ç›®å½•
        cp ../artifacts/* .      # ä¸‰ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶
        cp ../master.zip .       # æºç å‹ç¼©åŒ…
        cp ../version.txt .      # ç‰ˆæœ¬å·æ–‡ä»¶
        cp ../LICENSE .          # è®¸å¯è¯
        
        ls -la
        
        git add .
        git commit -m "Auto-Deploy Version ${{ needs.check_version.outputs.version_num }}"
        git push origin binaries --force
