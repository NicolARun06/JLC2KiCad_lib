name: Auto Build & Sync (Strict Versioning)

permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  # ===================================================
  # ä»»åŠ¡ä¸€ï¼šçœ‹é—¨äºº (å†å²ç‰ˆæœ¬å›æº¯ + å®Œæ•´æ€§æ£€æŸ¥)
  # ===================================================
  check_condition:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.analyze.outputs.should_run }}
      version_num: ${{ steps.analyze.outputs.version_num }}
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          fetch-depth: 100 # ã€å…³é”®ã€‘æ‹‰å–è¶³å¤Ÿæ·±çš„å†å²ï¼Œä»¥ä¾¿å›æº¯ç‰ˆæœ¬å·

      - name: Analyze Condition
        id: analyze
        shell: bash
        run: |
          # --- å‡½æ•°ï¼šä»å†å²è®°å½•ä¸­æå–æœ€è¿‘çš„ç‰ˆæœ¬å· ---
          function get_last_version() {
            # åœ¨æœ€è¿‘ 100 æ¡æäº¤ä¸­æœç´¢ç¬¦åˆ "version X -> Y" æ ¼å¼çš„è®°å½•
            # grep æå–ç‰ˆæœ¬å· Y
            local ver=$(git log -n 100 --pretty=%B | grep -oP "version\s+[0-9.]+\s+->\s+\K[0-9.]+" | head -n 1)
            
            if [[ -z "$ver" ]]; then
              echo "0.0.0" # å…œåº•ï¼Œå¦‚æœå®åœ¨æ‰¾ä¸åˆ°
            else
              echo "$ver"
            fi
          }

          # --- 1. è·å–åŸºå‡†ç‰ˆæœ¬å· (æ— è®ºå¦‚ä½•éƒ½è¦æœ‰ä¸€ä¸ªç‰ˆæœ¬å·) ---
          MSG=$(git log -1 --pretty=%B)
          echo "Current Commit: $MSG"
          REGEX="version\s+[0-9.]+\s+->\s+([0-9.]+)"
          
          if [[ "$MSG" =~ $REGEX ]]; then
             # å¦‚æœå½“å‰æäº¤å°±æ˜¯å‘ç‰ˆï¼Œç›´æ¥ç”¨
             CURRENT_VER="${BASH_REMATCH[1]}"
             echo "ğŸ¯ Detected NEW release in current commit: $CURRENT_VER"
          else
             # å¦‚æœå½“å‰ä¸æ˜¯å‘ç‰ˆï¼Œå›æº¯å†å²æ‰¾æœ€è¿‘çš„ä¸€ä¸ª
             CURRENT_VER=$(get_last_version)
             echo "ğŸ”™ Traceback found last version: $CURRENT_VER"
          fi

          # --- 2. æ£€æŸ¥ GitHub è¿œç¨‹åˆ†æ”¯åŠæ–‡ä»¶å®Œæ•´æ€§ ---
          echo "ğŸ” Checking remote branch status..."
          
          if git fetch origin binaries; then
            if git ls-tree -r origin/binaries | grep -q "JLC2KiCadLib_windows.exe" && \
               git ls-tree -r origin/binaries | grep -q "version.txt"; then
               echo "âœ… Artifacts intact."
               ARTIFACTS_OK="true"
            else
               echo "âš ï¸ Artifacts MISSING."
               ARTIFACTS_OK="false"
            fi
          else
            echo "âš ï¸ Branch MISSING."
            ARTIFACTS_OK="false"
          fi

          # --- 3. ç»¼åˆå†³ç­–é€»è¾‘ ---
          
          SHOULD_BUILD="false"
          FINAL_VER_TAG="$CURRENT_VER" # é»˜è®¤ä½¿ç”¨æå–åˆ°çš„å…·ä½“ç‰ˆæœ¬å·

          if [[ "$ARTIFACTS_OK" == "false" ]]; then
            echo "ğŸš€ Repair trigger. Rebuilding version $CURRENT_VER..."
            SHOULD_BUILD="true"

          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ğŸ‘† Manual trigger. Rebuilding version $CURRENT_VER..."
            SHOULD_BUILD="true"

          elif [[ "$MSG" =~ $REGEX ]]; then
            echo "ğŸ‰ New release trigger. Building version $CURRENT_VER..."
            SHOULD_BUILD="true"
            
          else
            echo "zzz No update & System healthy. Version stays at $CURRENT_VER. Skipping."
            SHOULD_BUILD="false"
          fi
          
          # è¾“å‡ºç»“æœ
          echo "should_run=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          echo "version_num=$FINAL_VER_TAG" >> $GITHUB_OUTPUT

  # ===================================================
  # ä»»åŠ¡äºŒï¼šçŸ©é˜µç¼–è¯‘
  # ===================================================
  build:
    needs: check_condition
    if: needs.check_condition.outputs.should_run == 'true'
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform_name: windows
            executable_name: JLC2KiCadLib.exe
            final_name: JLC2KiCadLib_windows.exe
          
          - os: ubuntu-22.04
            platform_name: linux
            executable_name: JLC2KiCadLib
            final_name: JLC2KiCadLib_linux

          - os: macos-15
            platform_name: macos_arm64
            executable_name: JLC2KiCadLib
            final_name: JLC2KiCadLib_macos_arm64

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests colorama pyinstaller

    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile JLC2KiCadLib/JLC2KiCadLib.py --name ${{ matrix.executable_name }}

    - name: Rename Output
      shell: bash
      run: |
        mv dist/${{ matrix.executable_name }} dist/${{ matrix.final_name }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.platform_name }}
        path: dist/${{ matrix.final_name }}

  # ===================================================
  # ä»»åŠ¡ä¸‰ï¼šåŒé‡éƒ¨ç½²
  # ===================================================
  deploy:
    needs: [check_condition, build]
    if: needs.check_condition.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Source for Zip
      uses: actions/checkout@v3
      
    - name: Prepare Files
      env:
        VERSION_TAG: ${{ needs.check_condition.outputs.version_num }}
      run: |
        zip -r master.zip . -x "*.git*" ".github*"
        # ä½¿ç”¨ Shell é»˜è®¤å€¼ï¼Œé˜²æ­¢ä¸ºç©º
        echo "${VERSION_TAG:-unknown}" > version.txt

    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: build-*
        merge-multiple: true
        path: ./artifacts

    - name: Push to Remotes
      env:
        GITEE_USER: ${{ secrets.GITEE_USER }}
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        GITEE_REPO: ${{ secrets.GITEE_REPO }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VERSION_TAG: ${{ needs.check_condition.outputs.version_num }}
      run: |
        # --- Git æ ¸å¿ƒé…ç½® (ä¿®å¤ RPC failed) ---
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # ã€å…³é”®ä¿®å¤ã€‘å¢åŠ ç¼“å†²åŒºå¤§å°åˆ° 500MB (524288000 bytes)
        git config --global http.postBuffer 524288000
        # ã€è¾…åŠ©ä¿®å¤ã€‘å¢åŠ åº•å±‚ä¼ è¾“çš„è¶…æ—¶æ—¶é—´
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        
        # --- å‡†å¤‡å·¥ä½œåŒº ---
        mkdir deploy_package
        cp artifacts/* deploy_package/
        cp master.zip deploy_package/
        cp version.txt deploy_package/
        cp LICENSE deploy_package/
        
        cd deploy_package
        git init
        git checkout -b binaries
        git add .
        
        COMMIT_MSG="Deploy Version ${VERSION_TAG:-auto-recovery}"
        git commit -m "$COMMIT_MSG"
        
        # --- æ¨é€é€»è¾‘ (å¢åŠ é‡è¯•æœºåˆ¶) ---
        git remote add github_origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
        git remote add gitee_origin "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_USER}/${GITEE_REPO}.git"
        
        echo "ğŸš€ Pushing to GitHub..."
        git push github_origin binaries --force
        
        echo "ğŸš€ Pushing to Gitee..."
        # Gitee æœ‰æ—¶æå…¶ä¸ç¨³å®šï¼Œè¿™é‡Œå…¶å®ä¹Ÿå¯ä»¥å°è¯•æ‰‹åŠ¨é‡è¯•ï¼Œä½†é€šå¸¸åŠ å¤§ buffer å°±èƒ½è§£å†³
        git push gitee_origin binaries --force
