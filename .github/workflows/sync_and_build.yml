name: Auto Build & Sync (GitHub + Gitee)

# æˆäºˆå†™æƒé™ï¼Œä»¥ä¾¿è„šæœ¬èƒ½å‘ä½ çš„ GitHub ä»“åº“æ¨é€ binaries åˆ†æ”¯
permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  # ===================================================
  # ä»»åŠ¡ä¸€ï¼šçœ‹é—¨äºº (æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º)
  # ===================================================
  check_condition:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.analyze.outputs.should_run }}
      version_num: ${{ steps.analyze.outputs.version_num }}
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿æ£€æŸ¥åˆ†æ”¯

      - name: Analyze Condition
        id: analyze
        shell: bash
        run: |
          # --- 1. æ£€æŸ¥ GitHub è¿œç¨‹æ˜¯å¦å­˜åœ¨ binaries åˆ†æ”¯ ---
          # å¦‚æœ git ls-remote è¿”å›ç©ºï¼Œè¯´æ˜åˆ†æ”¯ä¸å­˜åœ¨ï¼Œè¿™æ˜¯é¦–æ¬¡è¿è¡Œ
          if git ls-remote --exit-code --heads origin binaries; then
            echo "âœ… GitHub 'binaries' branch exists."
            BRANCH_EXISTS="true"
          else
            echo "âš ï¸ GitHub 'binaries' branch MISSING. First run detected!"
            BRANCH_EXISTS="false"
          fi

          # --- 2. æ£€æŸ¥ Commit Message ç‰ˆæœ¬å· ---
          MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $MSG"
          REGEX="version\s+[0-9.]+\s+->\s+([0-9.]+)"
          
          # --- 3. ç»¼åˆåˆ¤æ–­é€»è¾‘ ---
          
          if [[ "$BRANCH_EXISTS" == "false" ]]; then
            # æƒ…å†µA: é¦–æ¬¡è¿è¡Œ (åˆ†æ”¯ä¸å­˜åœ¨)ï¼Œå¼ºåˆ¶æ„å»º
            echo "ğŸš€ First run logic triggered. Forcing build."
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "version_num=init-build" >> $GITHUB_OUTPUT

          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # æƒ…å†µB: æ‰‹åŠ¨è§¦å‘ï¼Œå¼ºåˆ¶æ„å»º
            echo "ğŸ‘† Manual Trigger detected. Forcing build."
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "version_num=manual-build" >> $GITHUB_OUTPUT

          elif [[ "$MSG" =~ $REGEX ]]; then
            # æƒ…å†µC: å‘ç°åŸä½œè€…å‘ç‰ˆ (æ­£åˆ™åŒ¹é…æˆåŠŸ)
            NEW_VER="${BASH_REMATCH[1]}"
            echo "ğŸ‰ New Version detected: $NEW_VER"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "version_num=$NEW_VER" >> $GITHUB_OUTPUT
            
          else
            # æƒ…å†µD: æ— äº‹å‘ç”Ÿï¼Œè·³è¿‡
            echo "zzz No version change & branch exists. Sleeping."
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "version_num=none" >> $GITHUB_OUTPUT
          fi

  # ===================================================
  # ä»»åŠ¡äºŒï¼šçŸ©é˜µç¼–è¯‘ (Win, Linux, Mac-ARM)
  # ===================================================
  build:
    needs: check_condition
    if: needs.check_condition.outputs.should_run == 'true'
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform_name: windows
            executable_name: JLC2KiCadLib.exe
            final_name: JLC2KiCadLib_windows.exe
          
          - os: ubuntu-22.04
            platform_name: linux
            executable_name: JLC2KiCadLib
            final_name: JLC2KiCadLib_linux

          - os: macos-15
            platform_name: macos_arm64
            executable_name: JLC2KiCadLib
            final_name: JLC2KiCadLib_macos_arm64

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests colorama pyinstaller

    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile JLC2KiCadLib/JLC2KiCadLib.py --name ${{ matrix.executable_name }}

    - name: Rename Output
      shell: bash
      run: |
        mv dist/${{ matrix.executable_name }} dist/${{ matrix.final_name }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.platform_name }}
        path: dist/${{ matrix.final_name }}

  # ===================================================
  # ä»»åŠ¡ä¸‰ï¼šåŒé‡éƒ¨ç½² (GitHub + Gitee)
  # ===================================================
  deploy:
    needs: [check_condition, build]
    if: needs.check_condition.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Source for Zip
      uses: actions/checkout@v3
      
    # 1. å‡†å¤‡å‘å¸ƒæ–‡ä»¶
    - name: Prepare Files
      run: |
        # æ‰“åŒ…æºç 
        zip -r master.zip . -x "*.git*" ".github*"
        # ç”Ÿæˆç‰ˆæœ¬æ–‡ä»¶
        echo "${{ needs.check_condition.outputs.version_num }}" > version.txt

    # 2. ä¸‹è½½æ‰€æœ‰ç¼–è¯‘äº§ç‰©
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: build-*
        merge-multiple: true
        path: ./artifacts

    # 3. éƒ¨ç½²æ ¸å¿ƒé€»è¾‘
    - name: Push to Remotes
      env:
        # Gitee å¯†é’¥
        GITEE_USER: ${{ secrets.GITEE_USER }}
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        GITEE_REPO: ${{ secrets.GITEE_REPO }}
        # GitHub è‡ªåŠ¨ä»¤ç‰Œ
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # é…ç½® Git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # --- å‡†å¤‡å·¥ä½œåŒº ---
        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•æ¥å­˜æ”¾æˆ‘ä»¬è¦å‘å¸ƒçš„æ‰€æœ‰æ–‡ä»¶
        mkdir deploy_package
        cp artifacts/* deploy_package/
        cp master.zip deploy_package/
        cp version.txt deploy_package/
        cp LICENSE deploy_package/
        
        cd deploy_package
        git init
        git checkout -b binaries
        git add .
        git commit -m
